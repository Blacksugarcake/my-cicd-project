name: CI/CD Pipeline

# è§¸ç™¼æ¢ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '18'

jobs:
  # æ¸¬è©¦éšæ®µ
  test:
    name: ğŸ§ª æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: npm ci
    
    - name: ğŸ§ª åŸ·è¡Œæ¸¬è©¦
      run: npm test
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          coverage/
          test-results.xml
        retention-days: 7

  # å»ºç½®éšæ®µ
  build:
    name: ğŸ—ï¸ å»ºç½®
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: npm ci
    
    - name: ğŸ—ï¸ åŸ·è¡Œå»ºç½®
      run: npm run build
    
    - name: ğŸ“Š ä¸Šå‚³å»ºç½®çµæœ
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          app.js
          package.json
        retention-days: 7

  # éƒ¨ç½²éšæ®µï¼ˆåƒ…åœ¨ main åˆ†æ”¯ï¼‰
  deploy:
    name: ğŸš€ éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ ä¸‹è¼‰å»ºç½®çµæœ
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./build
    
    - name: ğŸš€ æ¨¡æ“¬éƒ¨ç½²
      run: |
        echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
        echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆï¼š"
        ls -la ./build/
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ æ‡‰ç”¨ç¨‹å¼å·²éƒ¨ç½²åˆ°: https://my-app.example.com"
    
    - name: ğŸ“ éƒ¨ç½²é€šçŸ¥
      run: |
        echo "ğŸ“¨ ç™¼é€éƒ¨ç½²é€šçŸ¥..."
        echo "âœ… å°ˆæ¡ˆ ${{ github.repository }} å·²æˆåŠŸéƒ¨ç½²"
        echo "ğŸ”— æäº¤: ${{ github.sha }}"
        echo "ğŸ‘¤ ä½œè€…: ${{ github.actor }}"

  # éƒ¨ç½²å¾Œæ¸¬è©¦
  post-deploy-test:
    name: ğŸ” éƒ¨ç½²å¾Œæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: npm ci
    
    - name: ğŸš€ å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
      run: |
        npm start &
        sleep 5
    
    - name: ğŸ” å¥åº·æª¢æŸ¥
      run: |
        curl -f http://localhost:3000/api/health || exit 1
        echo "âœ… æ‡‰ç”¨ç¨‹å¼å¥åº·æª¢æŸ¥é€šéï¼"
